<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>movies-info | Gerardo A. Guerrero Álvarez</title> <meta name="author" content="Gerardo A. Guerrero Álvarez"> <meta name="description" content="Data pipeline using a movies database API."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%99%BE%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://mellamanelpoeta.github.io/projects/1_project/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Gerardo </span>A. Guerrero Álvarez</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">movies-info</h1> <p class="post-description">Data pipeline using a movies database API.</p> </header> <article> <p><a href="https://github.com/mellamanelpoeta/movies-info" rel="external nofollow noopener" target="_blank">Github Repository</a></p> <p>The objective of the project is to integrate the following elements:</p> <ul> <li>Make requests to an API of our choice.</li> <li>Insert the responses to the requests into a MongoDB database, which will function as a DataLake.</li> <li>From the DataLake, it should be possible to make queries and perform an extraction, transformation, and loading process into two other databases: Cassandra and Neo4j.</li> <li>Incorporate all elements within a Docker-Compose.</li> <li>Throughout this document, the chosen API will be explained, how the project works, the requirements for its execution in any local environment, and some queries for each of the databases, along with an explanation of the results they yield.</li> </ul> <p><img src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_long_2-9665a76b1ae401a510ec1e0ca40ddcb3b0cfe45f1d51b77a308fea0845885648.svg" alt="image"></p> <h2 id="about-the-api-tmdb---the-movie-database-api">About the API: TMDB - The Movie Database API</h2> <p><a href="https://www.themoviedb.org/" rel="external nofollow noopener" target="_blank">The Movie Database (TMDB)</a> is an online database that contains a wide range of information about movies and TV shows. It provides details such as cast, production crew, release dates, synopses, ratings, user and critic scores, images, trailers, posters, and more. On the platform, users can contribute by adding information, correcting errors, or adding new content. This allows the database to stay up-to-date and accurate thanks to the participation of the user community. Additionally, users can rate movies and TV shows, helping to generate scores that reflect the overall community opinion about a particular title.</p> <p>In addition to being a consumer website, TMDb provides an API that allows developers to access its vast database to create applications, websites, and entertainment-related services. To access the API, registration on the platform is required, obtaining a key or token. The key is obtained for free, subject to platform authorization. The API documentation can also be reviewed on their site.</p> <h2 id="inicialización-del-proyecto">Inicialización del proyecto</h2> <p>To run this project on any computer, <a href="https://www.docker.com/get-started/" rel="external nofollow noopener" target="_blank">Docker</a> must be installed beforehand. Follow the instructions below:</p> <ul> <li>Clone this repository.</li> <li>Ensure that the Docker daemon is running.</li> <li>Navigate to the cloned repository’s folder and run the run.sh file in the terminal: <div class="language-shell highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>./run.sh
</code></pre></div> </div> <ul> <li>In this file, Docker-Compose is executed, which loads the containers and opens VSCode. Open the movie_app.ipynb file in VSCode.</li> <li>Run the notebook to visualize the results.</li> </ul> </li> </ul> <p>Queries for different databases should be executed in the terminal and can be found in the <a href="https://github.com/Thiago-whatever/ProyectoFinal_NoSQL/tree/main/Queries" rel="external nofollow noopener" target="_blank">Queries</a> folder of this repository.</p> <h2 id="mongodb">MongoDB</h2> <p>To transfer data from the API to MongoDB, a Python script was developed. This script establishes connections to both the API and MongoDB. However, it was found that requests with the URL ending in ‘/discover/movie’ did not provide sufficient information for the project. Therefore, this request is used to obtain movie IDs, and another request is made to a different URL. To avoid unnecessarily populating the database, the decision was made to select the top 20 most popular movies for each year from 1990 to 2024.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s">/movie/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s">?language=en-US</span><span class="sh">"</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="nf">insert_Mongo</span><span class="p">(</span><span class="n">movies_collection</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

</code></pre></div></div> <p>It was decided to have two collections: “movies” and “credits”. To handle this, a different method is used to download the data corresponding to credits, and it is shown below:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s">/movie/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s">/credits?language=en-US</span><span class="sh">"</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="nf">insert_Mongo</span><span class="p">(</span><span class="n">credits_collection</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
</code></pre></div></div> <p>Finally, it is worth highlighting the ‘insert_Mongo’ method, which helped populate the different collections with the various datasets:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">insert_Mongo</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">collection</span><span class="p">.</span><span class="nf">insert_one</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div> <p>For the movie request, which populates the “movies” collection, the response looked like the following:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"_id"</span><span class="p">:{</span><span class="nl">"$oid"</span><span class="p">:</span><span class="s2">"656848b139c28fac6b06808b"</span><span class="p">},</span><span class="w">
</span><span class="nl">"adult"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"backdrop_path"</span><span class="p">:</span><span class="s2">"/sw7mordbZxgITU877yTpZCud90M.jpg"</span><span class="p">,</span><span class="w">
</span><span class="nl">"belongs_to_collection"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="w">
</span><span class="nl">"budget"</span><span class="p">:</span><span class="mi">25000000</span><span class="p">,</span><span class="w">
</span><span class="nl">"genres"</span><span class="p">:[{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">18</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Drama"</span><span class="p">},{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">80</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Crime"</span><span class="p">}],</span><span class="w">
</span><span class="nl">"homepage"</span><span class="p">:</span><span class="s2">"http://www.warnerbros.com/goodfellas"</span><span class="p">,</span><span class="w">
</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">769</span><span class="p">,</span><span class="nl">"imdb_id"</span><span class="p">:</span><span class="s2">"tt0099685"</span><span class="p">,</span><span class="w">
</span><span class="nl">"original_language"</span><span class="p">:</span><span class="s2">"en"</span><span class="p">,</span><span class="w">
</span><span class="nl">"original_title"</span><span class="p">:</span><span class="s2">"GoodFellas"</span><span class="p">,</span><span class="w">
</span><span class="nl">"overview"</span><span class="p">:</span><span class="s2">"The true story of Henry Hill, a half-Irish, half-Sicilian Brooklyn kid who is adopted by neighbourhood gangsters at an early age and climbs the ranks of a Mafia family under the guidance of Jimmy Conway."</span><span class="p">,</span><span class="w">
</span><span class="nl">"popularity"</span><span class="p">:</span><span class="mf">85.372</span><span class="p">,</span><span class="w">
</span><span class="nl">"poster_path"</span><span class="p">:</span><span class="s2">"/aKuFiU82s5ISJpGZp7YkIr3kCUd.jpg"</span><span class="p">,</span><span class="w">
</span><span class="nl">"production_companies"</span><span class="p">:[{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">8880</span><span class="p">,</span><span class="nl">"logo_path"</span><span class="p">:</span><span class="s2">"/fE7LBw7Jz8R29EABFGCvWNriZxN.png"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Winkler Films"</span><span class="p">,</span><span class="w">
</span><span class="nl">"origin_country"</span><span class="p">:</span><span class="s2">"US"</span><span class="p">}],</span><span class="w">
</span><span class="nl">"production_countries"</span><span class="p">:[{</span><span class="nl">"iso_3166_1"</span><span class="p">:</span><span class="s2">"US"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"United States of America"</span><span class="p">}],</span><span class="w">
</span><span class="nl">"release_date"</span><span class="p">:</span><span class="s2">"1990-09-12"</span><span class="p">,</span><span class="w">
</span><span class="nl">"revenue"</span><span class="p">:</span><span class="mi">46835000</span><span class="p">,</span><span class="w">
</span><span class="nl">"runtime"</span><span class="p">:</span><span class="mi">145</span><span class="p">,</span><span class="w">
</span><span class="nl">"spoken_languages"</span><span class="p">:[{</span><span class="nl">"english_name"</span><span class="p">:</span><span class="s2">"Italian"</span><span class="p">,</span><span class="nl">"iso_639_1"</span><span class="p">:</span><span class="s2">"it"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Italiano"</span><span class="p">},{</span><span class="nl">"english_name"</span><span class="p">:</span><span class="s2">"English"</span><span class="p">,</span><span class="nl">"iso_639_1"</span><span class="p">:</span><span class="s2">"en"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"English"</span><span class="p">}],</span><span class="w">
</span><span class="nl">"status"</span><span class="p">:</span><span class="s2">"Released"</span><span class="p">,</span><span class="w">
</span><span class="nl">"tagline"</span><span class="p">:</span><span class="s2">"Three decades of life in the mafia."</span><span class="p">,</span><span class="w">
</span><span class="nl">"title"</span><span class="p">:</span><span class="s2">"GoodFellas"</span><span class="p">,</span><span class="w">
</span><span class="nl">"video"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
</span><span class="nl">"vote_average"</span><span class="p">:</span><span class="mf">8.466</span><span class="p">,</span><span class="w">
</span><span class="nl">"vote_count"</span><span class="p">:</span><span class="mi">11921</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>A portion of the response we obtained for credits (the entire document is too long to include, and the cast is extensive for each movie) is shown below:</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">769</span><span class="p">,</span><span class="w">
  </span><span class="nl">"cast"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"adult"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">11477</span><span class="p">,</span><span class="w">
      </span><span class="nl">"known_for_department"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Acting"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ray Liotta"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"original_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ray Liotta"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"popularity"</span><span class="p">:</span><span class="w"> </span><span class="mf">33.296</span><span class="p">,</span><span class="w">
      </span><span class="nl">"profile_path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/iXKotiB0Xe9iJLCBbjAedHPLb7p.jpg"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"cast_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w">
      </span><span class="nl">"character"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Henry Hill"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"credit_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"52fe4274c3a36847f801fd1f"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"order"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="err">...</span><span class="w">
</span></code></pre></div></div> <h2 id="cassandra">Cassandra</h2> <p>To perform the ETL process from MongoDB to Cassandra, several steps were involved, which we will see below. In addition to establishing the connection, a find({}) operation is performed for each of the collections we have. It’s worth mentioning that, beforehand, the keyspace in Cassandra is defined for operational purposes: “mov” is the keyspace used, but it is verified that there is no existing keyspace with that name. In case such a keyspace exists, it will be utilized.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Creation of keyspace
</span><span class="n">keyspace_name</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mov</span><span class="sh">"</span>

<span class="n">existing_keyspaces</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">.</span><span class="n">metadata</span><span class="p">.</span><span class="n">keyspaces</span>
<span class="k">if</span> <span class="n">keyspace_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_keyspaces</span><span class="p">:</span>
    <span class="n">session</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">CREATE KEYSPACE </span><span class="si">{</span><span class="n">keyspace_name</span><span class="si">}</span><span class="s"> WITH replication = class;</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <p>Next, the two tables are generated upon which we perform queries:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Table creation
</span><span class="n">create_movie_cast_query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    CREATE TABLE IF NOT EXISTS movie_cast (
        movie_id INT,
        cast_id INT,
        gender INT,
        name TEXT,
        character TEXT,
        popularity FLOAT,
        known_for_department TEXT,
        PRIMARY KEY (movie_id, cast_id, name)
    )
</span><span class="sh">"""</span>


<span class="n">create_movies_query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
    CREATE TABLE IF NOT EXISTS movies (
        movie_id INT,
        title TEXT,
        release_date DATE,
        genres SET&lt;TEXT&gt;,
        popularity FLOAT,
        budget FLOAT,
        revenue FLOAT,
        runtime INT,
        original_language TEXT,
        production_companies SET&lt;TEXT&gt;,
        production_countries SET&lt;TEXT&gt;,
        spoken_languages SET&lt;TEXT&gt;,
        PRIMARY KEY (movie_id, popularity)
    )
</span><span class="sh">"""</span>
</code></pre></div></div> <p>Finally, with the help of a cursor, the information is extracted from MongoDB, the transformation is carried out (we take the parts of the JSON documents that we want), and we load our tables into Cassandra. The following code snippet accomplishes this:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Funcion to insert data in movies table
</span><span class="k">def</span> <span class="nf">insert_movies</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
        INSERT INTO movies (movie_id, title, release_date, genres, popularity, budget, revenue, runtime, original_language, production_companies, production_countries, spoken_languages)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    </span><span class="sh">"""</span>
    <span class="n">prepared</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">prepare</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Establecer valores predeterminados si no existen datos en algunos campos
</span>            <span class="n">production_companies</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">production_companies</span><span class="sh">'</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">production_countries</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">production_countries</span><span class="sh">'</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">spoken_languages</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">spoken_languages</span><span class="sh">'</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">genres</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">genres</span><span class="sh">'</span><span class="p">,</span> <span class="p">[])</span>

            <span class="n">session</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">prepared</span><span class="p">,</span> <span class="p">(</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">],</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">],</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">'</span><span class="s">release_date</span><span class="sh">'</span><span class="p">],</span>
                <span class="nf">set</span><span class="p">([</span><span class="n">genre</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">]),</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">'</span><span class="s">popularity</span><span class="sh">'</span><span class="p">],</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">'</span><span class="s">budget</span><span class="sh">'</span><span class="p">],</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">'</span><span class="s">revenue</span><span class="sh">'</span><span class="p">],</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">'</span><span class="s">runtime</span><span class="sh">'</span><span class="p">],</span>
                <span class="n">entry</span><span class="p">[</span><span class="sh">'</span><span class="s">original_language</span><span class="sh">'</span><span class="p">],</span>
                <span class="nf">set</span><span class="p">([</span><span class="n">company</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">production_companies</span><span class="p">]),</span>
                <span class="nf">set</span><span class="p">([</span><span class="n">country</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">production_countries</span><span class="p">]),</span>
                <span class="nf">set</span><span class="p">([</span><span class="n">language</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">spoken_languages</span><span class="p">])</span>
            <span class="p">))</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error inserting entry: </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s">, Error: </span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">return</span>
</code></pre></div></div> <h2 id="neo4j">Neo4j</h2> <p>To carry out the ETL process from MongoDB to Neo4j, several steps were involved, which we will see below. First, the connection to both databases is established. For the transformation, all the information from both collections is retrieved with the help of a cursor, which will be processed using the Python pandas library.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Get data from mongo
</span><span class="n">cursor</span> <span class="o">=</span> <span class="n">mongo_collection</span><span class="p">.</span><span class="nf">find</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">cursor</span><span class="p">))</span>
</code></pre></div></div> <p>The processing to turn the cursor data into a graph is done as follows:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#title,genre, release_date df
</span><span class="n">df</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">_id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">adult</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">backdrop_path</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">belongs_to_collection</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">budget</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">homepage</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">,</span> 
                        <span class="sh">'</span><span class="s">tagline</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">video</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">vote_average</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">vote_count</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">imdb_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">original_language</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">original_title</span><span class="sh">'</span><span class="p">,</span>
                        <span class="sh">'</span><span class="s">overview</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">popularity</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">poster_path</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">revenue</span><span class="sh">'</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">df_normalized</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">explode</span><span class="p">(</span><span class="sh">'</span><span class="s">genres</span><span class="sh">'</span><span class="p">)</span>
<span class="n">df_normalized</span><span class="p">[</span><span class="sh">'</span><span class="s">genres</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_normalized</span><span class="p">[</span><span class="sh">'</span><span class="s">genres</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span> <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
<span class="n">df_genero</span> <span class="o">=</span> <span class="n">df_normalized</span><span class="p">[[</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">genres</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">title</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">release_date</span><span class="sh">'</span><span class="p">]]</span>
<span class="n">df_genero</span><span class="p">[</span><span class="sh">'</span><span class="s">release_date</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">df_genero</span><span class="p">[</span><span class="sh">'</span><span class="s">release_date</span><span class="sh">'</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="sh">'</span><span class="s">%Y-%m-%d</span><span class="sh">'</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="sh">'</span><span class="s">coerce</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <p>We generate the graph at last and it is loaded to Neo4j</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load1
</span><span class="k">def</span> <span class="nf">load1</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">movie_id</span><span class="p">,</span> <span class="n">genre</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">release_date</span><span class="p">):</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">release_date</span><span class="p">.</span><span class="n">year</span>

    <span class="c1"># Create nodes
</span>    <span class="n">tx</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sh">"""</span><span class="s">
        MERGE (g:Genre {name: $genre})
        MERGE (m:Movie {id: $id, title: $title})
        MERGE (y:Year {value: $year})
    </span><span class="sh">"""</span><span class="p">,</span> <span class="n">genre</span><span class="o">=</span><span class="n">genre</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>

    <span class="c1"># Crea las relaciones ENTRE entre género, película y año
</span>    <span class="n">tx</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sh">"""</span><span class="s">
        MATCH (g:Genre {name: $genre})
        MATCH (m:Movie {id: $id})
        MATCH (y:Year {value: $year})
        MERGE (m)-[:IS_GENRE_OF]-&gt;(g)
        MERGE (m)-[:RELEASED_IN]-&gt;(y)
    </span><span class="sh">"""</span><span class="p">,</span> <span class="n">genre</span><span class="o">=</span><span class="n">genre</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">movie_id</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>

<span class="c1"># Load to neo4j
</span><span class="k">with</span> <span class="n">GraphDatabase</span><span class="p">.</span><span class="nf">driver</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span><span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="sh">'</span><span class="s">neo4j</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">neoneo4j</span><span class="sh">'</span><span class="p">))</span> <span class="k">as</span> <span class="n">driver</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">driver</span><span class="p">.</span><span class="nf">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_genero</span><span class="p">.</span><span class="nf">iterrows</span><span class="p">():</span>
</code></pre></div></div> <h1 id="disclaimer">Disclaimer:</h1> <p>“This applicacion uses TMDB and the TMDB APIs but is not endorsed, certified, or otherwise approved by TMDB.”</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Gerardo A. Guerrero Álvarez. Last updated: December 13, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>